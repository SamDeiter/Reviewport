<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reviewport - UE5 Educational Tools Hub</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      :root {
        --bg-dark: #0d1117;
        --bg-card: #161b22;
        --bg-card-hover: #21262d;
        --border: #30363d;
        --text-primary: #e6edf3;
        --text-secondary: #8b949e;
        --accent-blue: #58a6ff;
        --accent-purple: #8b5cf6;
        --accent-green: #3fb950;
        --accent-orange: #f0883e;
        --accent-red: #f85149;
        --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --gradient-card: linear-gradient(145deg, #1a1f29 0%, #0d1117 100%);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          "Inter",
          -apple-system,
          BlinkMacSystemFont,
          sans-serif;
        background: var(--bg-dark);
        color: var(--text-primary);
        min-height: 100vh;
        overflow-x: hidden;
      }

      /* Animated background */
      .bg-gradient {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background:
          radial-gradient(
            ellipse at 20% 20%,
            rgba(88, 166, 255, 0.1) 0%,
            transparent 50%
          ),
          radial-gradient(
            ellipse at 80% 80%,
            rgba(139, 92, 246, 0.1) 0%,
            transparent 50%
          ),
          radial-gradient(
            ellipse at 50% 50%,
            rgba(63, 185, 80, 0.05) 0%,
            transparent 50%
          );
        z-index: -1;
        animation: pulse 15s ease-in-out infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
      }

      /* Header */
      header {
        padding: 2rem 4rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid var(--border);
        backdrop-filter: blur(10px);
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .logo-icon {
        width: 48px;
        height: 48px;
        background: var(--gradient-primary);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
      }

      .logo-text {
        font-size: 1.5rem;
        font-weight: 700;
        background: var(--gradient-primary);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .logo-subtitle {
        font-size: 0.75rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.1em;
      }

      .user-area {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .login-btn {
        background: var(--bg-card);
        border: 1px solid var(--border);
        color: var(--text-primary);
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .login-btn:hover {
        background: var(--bg-card-hover);
        border-color: var(--accent-blue);
      }

      /* Main content */
      main {
        max-width: 1400px;
        margin: 0 auto;
        padding: 3rem 2rem;
      }

      .hero {
        text-align: center;
        margin-bottom: 4rem;
      }

      .hero h1 {
        font-size: 3rem;
        font-weight: 700;
        margin-bottom: 1rem;
        background: linear-gradient(135deg, #fff 0%, #8b949e 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .hero p {
        font-size: 1.25rem;
        color: var(--text-secondary);
        max-width: 600px;
        margin: 0 auto;
      }

      /* Stats bar */
      .stats-bar {
        display: flex;
        justify-content: center;
        gap: 3rem;
        margin: 2rem 0 4rem;
        flex-wrap: wrap;
      }

      .stat {
        text-align: center;
      }

      .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--accent-blue);
      }

      .stat-label {
        font-size: 0.875rem;
        color: var(--text-secondary);
      }

      /* Tools grid */
      .section-title {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .section-title i {
        color: var(--accent-purple);
      }

      .tools-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 1.5rem;
        margin-bottom: 3rem;
      }

      .tool-card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 1.5rem;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
      }

      .tool-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--card-accent, var(--accent-blue));
      }

      .tool-card:hover {
        transform: translateY(-4px);
        border-color: var(--card-accent, var(--accent-blue));
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
      }

      .tool-card.blueprint {
        --card-accent: var(--accent-blue);
      }
      .tool-card.scenario {
        --card-accent: var(--accent-purple);
      }
      .tool-card.question {
        --card-accent: var(--accent-green);
      }
      .tool-card.material {
        --card-accent: var(--accent-orange);
      }

      .tool-header {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        margin-bottom: 1rem;
      }

      .tool-icon {
        width: 56px;
        height: 56px;
        background: var(--bg-dark);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
      }

      .tool-card.blueprint .tool-icon {
        color: var(--accent-blue);
      }
      .tool-card.scenario .tool-icon {
        color: var(--accent-purple);
      }
      .tool-card.question .tool-icon {
        color: var(--accent-green);
      }
      .tool-card.material .tool-icon {
        color: var(--accent-orange);
      }

      .tool-status {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.75rem;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        background: rgba(63, 185, 80, 0.1);
        color: var(--accent-green);
      }

      .tool-status.offline {
        background: rgba(248, 81, 73, 0.1);
        color: var(--accent-red);
      }

      .tool-status .dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: currentColor;
        animation: blink 2s infinite;
      }

      @keyframes blink {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .tool-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
      }

      .tool-description {
        color: var(--text-secondary);
        font-size: 0.875rem;
        line-height: 1.5;
        margin-bottom: 1rem;
      }

      .tool-stats {
        display: flex;
        gap: 1rem;
        font-size: 0.75rem;
        color: var(--text-secondary);
        border-top: 1px solid var(--border);
        padding-top: 1rem;
        margin-top: 1rem;
      }

      .tool-stats span {
        display: flex;
        align-items: center;
        gap: 0.25rem;
      }

      .tool-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
      }

      .btn {
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
      }

      .btn-primary {
        background: var(--accent-blue);
        color: #fff;
      }

      .btn-primary:hover {
        background: #79b8ff;
      }

      .btn-secondary {
        background: var(--bg-dark);
        color: var(--text-primary);
        border: 1px solid var(--border);
      }

      .btn-secondary:hover {
        border-color: var(--accent-blue);
      }

      /* Quick actions */
      .quick-actions {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        margin-top: 2rem;
        padding: 1.5rem;
        background: var(--bg-card);
        border-radius: 12px;
        border: 1px solid var(--border);
      }

      .quick-action {
        flex: 1;
        min-width: 200px;
        padding: 1rem;
        background: var(--bg-dark);
        border-radius: 8px;
        border: 1px solid var(--border);
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
        color: inherit;
      }

      .quick-action:hover {
        border-color: var(--accent-blue);
        transform: translateY(-2px);
      }

      .quick-action i {
        font-size: 1.5rem;
        color: var(--accent-blue);
        margin-bottom: 0.5rem;
      }

      .quick-action h4 {
        font-size: 0.875rem;
        margin-bottom: 0.25rem;
      }

      .quick-action p {
        font-size: 0.75rem;
        color: var(--text-secondary);
      }

      /* Footer */
      footer {
        text-align: center;
        padding: 2rem;
        color: var(--text-secondary);
        font-size: 0.875rem;
        border-top: 1px solid var(--border);
        margin-top: 4rem;
      }

      footer a {
        color: var(--accent-blue);
        text-decoration: none;
      }

      /* Responsive */
      @media (max-width: 768px) {
        header {
          padding: 1rem;
          flex-direction: column;
          gap: 1rem;
        }

        .hero h1 {
          font-size: 2rem;
        }

        .stats-bar {
          gap: 1.5rem;
        }
      }

      /* Login Overlay */
      .login-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: var(--bg-dark);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        flex-direction: column;
        gap: 2rem;
      }

      .login-overlay.hidden {
        display: none;
      }

      .login-card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 3rem;
        text-align: center;
        max-width: 400px;
      }

      .login-card h2 {
        margin-bottom: 0.5rem;
        font-size: 1.5rem;
      }

      .login-card p {
        color: var(--text-secondary);
        margin-bottom: 2rem;
        font-size: 0.875rem;
      }

      .login-card .epic-notice {
        background: rgba(88, 166, 255, 0.1);
        border: 1px solid var(--accent-blue);
        border-radius: 8px;
        padding: 0.75rem;
        margin-top: 1.5rem;
        font-size: 0.75rem;
        color: var(--accent-blue);
      }

      .google-signin-btn {
        background: #fff;
        color: #333;
        border: none;
        padding: 0.875rem 1.5rem;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin: 0 auto;
        transition: all 0.2s;
      }

      .google-signin-btn:hover {
        background: #f1f1f1;
        transform: translateY(-2px);
      }

      .google-signin-btn img {
        width: 20px;
        height: 20px;
      }

      .auth-error {
        background: rgba(248, 81, 73, 0.1);
        border: 1px solid var(--accent-red);
        border-radius: 8px;
        padding: 0.75rem;
        margin-top: 1rem;
        font-size: 0.875rem;
        color: var(--accent-red);
      }

      .auth-error.hidden {
        display: none;
      }

      .user-profile {
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .user-profile img {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: 2px solid var(--accent-blue);
      }

      .user-profile .user-name {
        font-size: 0.875rem;
        font-weight: 500;
      }

      .logout-btn {
        background: transparent;
        border: 1px solid var(--border);
        color: var(--text-secondary);
        padding: 0.5rem 1rem;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.75rem;
        transition: all 0.2s;
      }

      .logout-btn:hover {
        border-color: var(--accent-red);
        color: var(--accent-red);
      }

      .app-content.visible {
        display: block;
      }

      /* Admin Panel Styles */
      .admin-section {
        margin-top: 4rem;
        padding-top: 2rem;
        border-top: 1px dashed var(--border);
        display: none; /* Hidden by default */
      }

      .admin-section.visible {
        display: block;
      }

      .admin-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 2rem;
        margin-top: 1.5rem;
      }

      .admin-card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 2rem;
      }

      .admin-card h3 {
        margin-bottom: 1.5rem;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--accent-blue);
      }

      .tool-selector {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        margin-bottom: 2rem;
        padding: 1.5rem;
        background: var(--bg-dark);
        border-radius: 8px;
        border: 1px solid var(--border);
      }

      .tool-checkbox {
        display: flex;
        align-items: center;
        gap: 1rem;
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 6px;
        transition: background 0.2s;
      }

      .tool-checkbox:hover {
        background: var(--bg-card-hover);
      }

      .tool-checkbox input {
        width: 18px;
        height: 18px;
        accent-color: var(--accent-blue);
      }

      .invite-link-area {
        margin-top: 1.5rem;
        display: none;
      }

      .invite-link-area.visible {
        display: block;
      }

      .copy-area {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.5rem;
      }

      .copy-input {
        flex: 1;
        background: var(--bg-dark);
        border: 1px solid var(--border);
        color: var(--text-primary);
        padding: 0.75rem;
        border-radius: 6px;
        font-family: monospace;
        font-size: 0.875rem;
      }

      .admin-actions {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .system-btn {
        width: 100%;
        justify-content: center;
        padding: 1rem;
      }
    </style>
  </head>
  <body>
    <div class="bg-gradient"></div>

    <header>
      <div class="logo">
        <div class="logo-icon">
          <img src="logos/UE-Icon-2023-White.svg" alt="UE5" style="width: 32px; height: 32px;">
        </div>
        <div>
          <div class="logo-text">Reviewport</div>
          <div class="logo-subtitle">UE5 Educational Tools</div>
        </div>
      </div>
      <div class="user-area" id="user-area">
        <!-- Will be populated by auth state -->
      </div>
    </header>

    <!-- Login Overlay -->
    <div class="login-overlay" id="login-overlay">
      <div class="login-card">
        <div style="margin: 0 auto 1.5rem;">
          <img src="logos/UE-Icon-2023-White.svg" alt="UE5" style="width: 80px; height: 80px;">
        </div>
        <h2>Welcome to Reviewport</h2>
        <p>Sign in with your Epic Games Google account to access the UE5 Educational Tools Hub.</p>
        <button class="google-signin-btn" id="google-signin-btn" onclick="signInWithGoogle()">
          <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
          Sign in with Google
        </button>
        <div class="auth-error hidden" id="auth-error"></div>
        <div class="epic-notice">
          <i class="fas fa-shield-alt"></i>
          Access restricted to @epicgames.com accounts
        </div>
      </div>
    </div>

    <!-- App Content (hidden until authenticated) -->
    <div class="app-content" id="app-content">
    <main>
      <section class="hero">
        <h1>UE5 Educational Tools Hub</h1>
        <p>
          Review, track, and manage all your Unreal Engine 5 educational content
          from one central location.
        </p>
      </section>

      <div class="stats-bar">
        <div class="stat">
          <div class="stat-value" id="scenario-count">21</div>
          <div class="stat-label">Scenarios</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="question-count">0</div>
          <div class="stat-label">Questions</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="review-count">0</div>
          <div class="stat-label">Reviews Pending</div>
        </div>
        <div class="stat">
          <div class="stat-value">3</div>
          <div class="stat-label">Active Tools</div>
        </div>
      </div>

      <h2 class="section-title">
        <i class="fas fa-tools"></i>
        Educational Tools
      </h2>

      <div class="tools-grid">
        <!-- Blueprint Editor -->
        <div class="tool-card blueprint" onclick="launchTool('blueprint')">
          <div class="tool-header">
            <div class="tool-icon">
              <i class="fas fa-project-diagram"></i>
            </div>
            <div class="tool-status" id="blueprint-status">
              <span class="dot"></span>
              Online
            </div>
          </div>
          <h3 class="tool-title">Blueprint Editor</h3>
          <p class="tool-description">
            Interactive visual scripting environment that replicates UE5's
            Blueprint system. Perfect for teaching BP fundamentals.
          </p>
          <div class="tool-stats">
            <span><i class="fas fa-cube"></i> 27 Tasks</span>
            <span><i class="fas fa-bug"></i> 5 BP Scenarios</span>
          </div>
          <div class="tool-actions">
            <button
              class="btn btn-primary"
              onclick="
                event.stopPropagation();
                launchTool('blueprint');
              "
            >
              <i class="fas fa-play"></i> Launch
            </button>
            <button
              class="btn btn-secondary"
              onclick="
                event.stopPropagation();
                launchTool('blueprint-review');
              "
            >
              <i class="fas fa-search"></i> Review Mode
            </button>
          </div>
        </div>

        <!-- Scenario Tracker -->
        <div class="tool-card scenario" onclick="launchTool('scenario')">
          <div class="tool-header">
            <div class="tool-icon">
              <i class="fas fa-map-marked-alt"></i>
            </div>
            <div class="tool-status" id="scenario-status">
              <span class="dot"></span>
              Online
            </div>
          </div>
          <h3 class="tool-title">Scenario Tracker</h3>
          <p class="tool-description">
            Comprehensive library of real-world UE5 troubleshooting scenarios
            across 5 disciplines. Track progress and validate learning.
          </p>
          <div class="tool-stats">
            <span><i class="fas fa-folder"></i> 5 Disciplines</span>
            <span><i class="fas fa-file-alt"></i> 45 Scenarios</span>
            <span><i class="fas fa-check-circle"></i> 0 Reviewed</span>
          </div>
          <div class="tool-actions">
            <button
              class="btn btn-primary"
              onclick="
                event.stopPropagation();
                launchTool('scenario');
              "
            >
              <i class="fas fa-play"></i> Launch
            </button>
            <button
              class="btn btn-secondary"
              onclick="
                event.stopPropagation();
                launchTool('scenario-review');
              "
            >
              <i class="fas fa-search"></i> Review Mode
            </button>
          </div>
        </div>

        <!-- Question Generator -->
        <div class="tool-card question" onclick="launchTool('question')">
          <div class="tool-header">
            <div class="tool-icon">
              <i class="fas fa-question-circle"></i>
            </div>
            <div class="tool-status offline" id="question-status">
              <span class="dot"></span>
              Offline
            </div>
          </div>
          <h3 class="tool-title">Question Generator</h3>
          <p class="tool-description">
            AI-powered quiz generation tool that creates multiple-choice
            questions from UE5 documentation with source verification.
          </p>
          <div class="tool-stats">
            <span
              ><i class="fas fa-list"></i>
              <span id="question-card-count">...</span> Questions</span
            >
            <span
              ><i class="fas fa-check-circle"></i>
              <span id="verified-count">...</span> Verified</span
            >
            <span
              ><i class="fas fa-clock"></i>
              <span id="pending-count">...</span> Pending</span
            >
          </div>
          <div class="tool-actions">
            <button
              class="btn btn-primary"
              onclick="
                event.stopPropagation();
                launchTool('question');
              "
            >
              <i class="fas fa-play"></i> Launch
            </button>
            <button
              class="btn btn-secondary"
              onclick="
                event.stopPropagation();
                launchTool('question-review');
              "
            >
              <i class="fas fa-search"></i> Review Mode
            </button>
          </div>
        </div>
      </div>

      <!-- Unified Access Management (Admins Only) -->
      <section class="admin-section" id="admin-panel">
        <h2 class="section-title">
          <i class="fas fa-user-shield"></i>
          Unified Access Management
        </h2>
        
        <div class="admin-grid">
          <!-- Invite Generator -->
          <div class="admin-card">
            <h3><i class="fas fa-plus-circle"></i> Create Reviewer Invite</h3>
            <p style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 1.5rem;">
              Select the tools this reviewer should have access to. Each link is single-use.
            </p>
            
            <div class="tool-selector">
              <label class="tool-checkbox">
                <input type="checkbox" name="tool" value="questions" checked>
                <div>
                  <div style="font-weight: 500;">Question Generator</div>
                  <div style="font-size: 0.75rem; color: var(--text-secondary);">AI-powered MCQ generation & verification</div>
                </div>
              </label>
              <label class="tool-checkbox">
                <input type="checkbox" name="tool" value="blueprint">
                <div>
                  <div style="font-weight: 500;">Blueprint Editor</div>
                  <div style="font-size: 0.75rem; color: var(--text-secondary);">Visual scripting review scenarios</div>
                </div>
              </label>
              <label class="tool-checkbox">
                <input type="checkbox" name="tool" value="scenario">
                <div>
                  <div style="font-weight: 500;">Scenario Tracker</div>
                  <div style="font-size: 0.75rem; color: var(--text-secondary);">Text-based troubleshooting reviews</div>
                </div>
              </label>
               <label class="tool-checkbox">
                <input type="checkbox" name="tool" value="materials">
                <div>
                  <div style="font-weight: 500;">Materials Hub</div>
                  <div style="font-size: 0.75rem; color: var(--text-secondary);">Shader & material logic evaluation</div>
                </div>
              </label>
            </div>
            
            <button class="btn btn-primary system-btn" onclick="generateInviteLink()">
              <i class="fas fa-link"></i> Generate Invite Link
            </button>

            <div class="invite-link-area" id="invite-link-area">
              <div style="font-size: 0.75rem; color: var(--accent-green); margin-top: 1rem;">Invite Code Generated:</div>
              <div class="copy-area">
                <input type="text" class="copy-input" id="invite-url" readonly>
                <button class="btn btn-secondary" onclick="copyInviteUrl()">
                  <i class="fas fa-copy"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- System Migration Tools -->
          <div class="admin-card">
            <h3><i class="fas fa-database"></i> System Tools</h3>
            <p style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 1.5rem;">
              Critical system maintenance and initialization tools.
            </p>
            <div class="admin-actions">
              <button class="btn btn-secondary system-btn" onclick="runAccessMigration()">
                <i class="fas fa-sync-alt"></i> Run Access Migration (Legacy Users)
              </button>
              <button class="btn btn-secondary system-btn" onclick="seedToolRegistry()">
                <i class="fas fa-seedling"></i> Seed Tool Registry
              </button>
              <div id="system-status" style="font-size: 0.75rem; margin-top: 1rem; text-align: center;"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Quick Actions -->
      <h2 class="section-title">
        <i class="fas fa-bolt"></i>
        Quick Actions
      </h2>

      <div class="quick-actions">
        <a
          class="quick-action"
          href="https://samdeiter.github.io/UE5LMSBlueprint/?mode=review"
          target="_blank"
        >
          <i class="fas fa-clipboard-check"></i>
          <h4>Review Blueprint Scenarios</h4>
          <p>Open Blueprint Editor in Review Mode</p>
        </a>
        <a
          class="quick-action"
          href="./tools/scenario-review/index.html"
          target="_blank"
        >
          <i class="fas fa-edit"></i>
          <h4>Review Text Scenarios</h4>
          <p>Open Scenario Tracker for text reviews</p>
        </a>
        <a
          class="quick-action"
          href="#"
          onclick="
            exportReport();
            return false;
          "
        >
          <i class="fas fa-file-export"></i>
          <h4>Export Review Report</h4>
          <p>Generate a summary of all reviews</p>
        </a>
        <a
          class="quick-action"
          href="https://drive.google.com/drive/folders/1QUjAnB8HxcsKsLDewC9kzdcJQtsezJCH"
          target="_blank"
        >
          <i class="fab fa-google-drive"></i>
          <h4>Open Drive Folder</h4>
          <p>View screenshots and review data</p>
        </a>
      </div>
    </main>

    <footer>
      <p>Reviewport v0.2.1 &bull; Built for Epic Games Learning Team</p>
      <p style="margin-top: 0.5rem">
        <a href="https://github.com/SamDeiter" target="_blank">GitHub</a> &bull;
        <a
          href="#"
          onclick="
            showDocs();
            return false;
          "
          >Documentation</a
        >
      </p>
    </footer>
    </div><!-- End app-content -->

    <script>
      // Tool URLs configuration
      const TOOLS = {
        blueprint: "https://samdeiter.github.io/UE5LMSBlueprint/",
        "blueprint-review":
          "https://samdeiter.github.io/UE5LMSBlueprint/?mode=review",
        scenario: "https://samdeiter.github.io/UE5ScenarioTracker/",
        "scenario-review": "https://samdeiter.github.io/UE5ScenarioTracker/?mode=review",
        question: "https://samdeiter.github.io/UE5QuestionGenerator/",
        "question-review":
          "https://samdeiter.github.io/UE5QuestionGenerator/?mode=review",
      };

      // Google Drive configuration for screenshot storage
      const DRIVE_CONFIG = {
        folderId: "1QUjAnB8HxcsKsLDewC9kzdcJQtsezJCH",
        folderUrl:
          "https://drive.google.com/drive/folders/1QUjAnB8HxcsKsLDewC9kzdcJQtsezJCH",
      };

      async function launchTool(toolId) {
        const url = TOOLS[toolId];
        if (!url) return;

        // 1. Epic Games employees have auto-access to everything
        if (auth.currentUser && auth.currentUser.email.toLowerCase().endsWith("@epicgames.com")) {
          window.open(url, "_blank");
          return;
        }

        // 2. Check per-tool access for external users
        try {
          // Normalize toolId (e.g., 'blueprint-review' -> 'blueprint')
          const baseToolId = toolId.split('-')[0];
          
          const checkAccessFn = functions.httpsCallable("checkToolAccess");
          const result = await checkAccessFn({ toolId: baseToolId });
          
          if (result.data.hasAccess) {
            window.open(url, "_blank");
          } else {
            alert(`Access Denied: You do not have permission to access the ${baseToolId} tool. Please request an invite link for this tool.`);
          }
        } catch (error) {
          console.error("[Access] Check failed:", error);
          alert("Failed to verify access. Please try again later.");
        }
      }

      function showLoginInfo() {
        alert(
          "Google Authentication will be configured with Firebase Auth.\n\nFor Epic Games employees, access will be restricted to @epicgames.com domain.",
        );
      }

      function exportReport() {
        const report = {
          timestamp: new Date().toISOString(),
          stats: {
            scenarios: document.getElementById("scenario-count").textContent,
            questions: document.getElementById("question-count").textContent,
            pending: document.getElementById("review-count").textContent,
          },
          tools: Object.keys(TOOLS),
        };

        const blob = new Blob([JSON.stringify(report, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `review-report-${new Date().toISOString().slice(0, 10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      function syncData() {
        if (confirm("Open Google Drive folder to verify synced data?")) {
          window.open(DRIVE_CONFIG.folderUrl, "_blank");
        }
      }

      function showDocs() {
        window.open("https://github.com/SamDeiter/Reviewport/wiki", "_blank");
      }

      // Check tool status on load
      // Status check for GitHub Pages tools
      // Since these are static GitHub Pages sites, they're always available
      async function checkToolStatus() {
        const tools = [
          { id: "blueprint-status", url: "https://samdeiter.github.io/UE5LMSBlueprint/" },
          { id: "scenario-status", url: "https://samdeiter.github.io/UE5ScenarioTracker/" },
        ];

        for (const tool of tools) {
          const el = document.getElementById(tool.id);
          if (el) {
            // GitHub Pages are static and always available
            el.classList.remove("offline");
            el.innerHTML = '<span class="dot"></span> Available';
          }
        }
      }

      // Run status check on load
      checkToolStatus();

      // Firebase configuration for Question Generator
      // Load Firebase SDK
      const firebaseScript = document.createElement("script");
      firebaseScript.src =
        "https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js";
      firebaseScript.onload = () => {
        const authScript = document.createElement("script");
        authScript.src =
          "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js";
        authScript.onload = () => {
          const firestoreScript = document.createElement("script");
          firestoreScript.src =
            "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js";
          firestoreScript.onload = () => {
            const functionsScript = document.createElement("script");
            functionsScript.src =
              "https://www.gstatic.com/firebasejs/10.7.0/firebase-functions-compat.js";
            functionsScript.onload = initFirebase;
            document.head.appendChild(functionsScript);
          };
          document.head.appendChild(firestoreScript);
        };
        document.head.appendChild(authScript);
      };
      document.head.appendChild(firebaseScript);

      // Allowed email domain
      const ALLOWED_DOMAIN = "@epicgames.com";
      
      // Global Firebase references
      let auth, db;

      async function initFirebase() {
        try {
          // Firebase config for ue5-questions-prod
          // API key is restricted to *.samdeiter.github.io/* in Firebase Console
          const firebaseConfig = {
            apiKey: "AIzaSyDHtXGk_e5ntXOqTBAr5whLnVU8LaWsqOQ",
            authDomain: "ue5-questions-prod.firebaseapp.com",
            projectId: "ue5-questions-prod",
            storageBucket: "ue5-questions-prod.firebasestorage.app",
            messagingSenderId: "15582589888",
            appId: "1:15582589888:web:b767b6bb3a16bf5f42695b5",
            measurementId: "G-3L7FJ56DMH"
          };

          firebase.initializeApp(firebaseConfig);
          auth = firebase.auth();
          db = firebase.firestore();
          functions = firebase.functions();

          // Listen for auth state changes
          auth.onAuthStateChanged(handleAuthStateChange);
          
          console.log("[Auth] Firebase initialized");
        } catch (error) {
          console.error("Firebase init error:", error);
          showAuthError("Failed to initialize. Please refresh the page.");
        }
      }

      function handleAuthStateChange(user) {
        const loginOverlay = document.getElementById("login-overlay");
        const appContent = document.getElementById("app-content");
        const userArea = document.getElementById("user-area");
        
        if (user) {
          // Check domain restriction
          const urlParams = new URLSearchParams(window.location.search);
          const hasInvite = urlParams.has('invite');
          
          if (!hasInvite && !user.email.toLowerCase().endsWith(ALLOWED_DOMAIN.toLowerCase())) {
            console.warn(`[Auth] Rejected: ${user.email} (not ${ALLOWED_DOMAIN})`);
            showAuthError(`Access restricted to ${ALLOWED_DOMAIN} accounts only. If you have an invite, please use the invite link.`);
            auth.signOut();
            return;
          }
          
          // User is authenticated with valid domain
          console.log(`[Auth] Authenticated: ${user.email}`);
          
          // Hide login, show content
          loginOverlay.classList.add("hidden");
          appContent.classList.add("visible");
          
          // Update header with user info
          userArea.innerHTML = `
            <div class="user-profile">
              <img src="${user.photoURL || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(user.displayName || 'User')}" alt="${user.displayName}" onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(user.displayName || 'User')}&background=667eea&color=fff'">
              <span class="user-name">${user.displayName || user.email}</span>
              <button class="logout-btn" onclick="signOut()">Sign Out</button>
            </div>
          `;
          
          // Load data now that user is authenticated
          loadQuestionStats();
          checkAdminAccess();
          checkInviteCode();
          
        } else {
          // User is not authenticated
          console.log("[Auth] No user signed in");
          
          // Check for invite in URL even if not signed in (to show login prompt)
          const urlParams = new URLSearchParams(window.location.search);
          if (urlParams.has('invite')) {
            showAuthError("You have an invite link! Please sign in with your Google account to accept it.");
          }
          
          // Show login, hide content
          loginOverlay.classList.remove("hidden");
          appContent.classList.remove("visible");
          
          // Reset header
          userArea.innerHTML = "";
        }
      }

      async function signInWithGoogle() {
        try {
          hideAuthError();
          const provider = new firebase.auth.GoogleAuthProvider();
          
          // Only hint/force epicgames.com if NO invite is present.
          // Holders of specific tool invites can use personal accounts.
          const urlParams = new URLSearchParams(window.location.search);
          if (!urlParams.has('invite')) {
            provider.setCustomParameters({
              hd: 'epicgames.com',
              prompt: 'select_account'
            });
          } else {
            provider.setCustomParameters({
              prompt: 'select_account'
            });
          }
          
          await auth.signInWithPopup(provider);
        } catch (error) {
          console.error("[Auth] Sign-in error:", error);
          if (error.code === 'auth/popup-closed-by-user') {
            // User closed popup, don't show error
            return;
          }
          showAuthError("Sign-in failed. Please try again.");
        }
      }

      function signOut() {
        auth.signOut().then(() => {
          console.log("[Auth] Signed out");
        }).catch((error) => {
          console.error("[Auth] Sign-out error:", error);
        });
      }

      function showAuthError(message) {
        const errorEl = document.getElementById("auth-error");
        errorEl.textContent = message;
        errorEl.classList.remove("hidden");
      }

      function hideAuthError() {
        const errorEl = document.getElementById("auth-error");
        errorEl.classList.add("hidden");
      }

      async function loadQuestionStats() {
        try {
          // Get question counts
          const snapshot = await db.collection("questions").get();
          const total = snapshot.size;

          let verified = 0;
          let pending = 0;
          snapshot.forEach((doc) => {
            const data = doc.data();
            if (data.humanVerified) {
              verified++;
            } else {
              pending++;
            }
          });

          // Update UI
          document.getElementById("question-count").textContent = total;
          document.getElementById("question-card-count").textContent = total;
          document.getElementById("verified-count").textContent = verified;
          document.getElementById("pending-count").textContent = pending;
          document.getElementById("review-count").textContent = pending;

          // Update status to online
          const statusEl = document.getElementById("question-status");
          if (statusEl) {
            statusEl.classList.remove("offline");
            statusEl.innerHTML = '<span class="dot"></span> Online';
          }

          console.log(
            `[Data] Loaded ${total} questions (${verified} verified, ${pending} pending)`,
          );
        } catch (error) {
          console.error("Firebase error:", error);
          document.getElementById("question-card-count").textContent = "?";
          document.getElementById("verified-count").textContent = "?";
          document.getElementById("pending-count").textContent = "?";
        }
      }

      // --- Admin Functions ---

      async function checkAdminAccess() {
        try {
          if (!auth.currentUser) return;
          
          // Epic Games employees are auto-admins (frontend check for immediate UI)
          if (auth.currentUser.email.toLowerCase().endsWith("@epicgames.com")) {
            console.log("[Admin] Auto-access granted (Epic Employee)");
            document.getElementById("admin-panel").classList.add("visible");
            return;
          }

          const checkFn = functions.httpsCallable("checkUserRegistration");
          const result = await checkFn({});
          const userData = result.data;
          
          console.log("[Admin] Registration check result:", userData);
          
          if (userData && userData.role === "admin") {
            console.log("[Admin] Access detected via registry");
            document.getElementById("admin-panel").classList.add("visible");
          } else {
            console.log("[Admin] No admin role detected");
          }
        } catch (error) {
          console.error("[Admin] Access check failed:", error);
        }
      }

      async function generateInviteLink() {
        const btn = event.target;
        const originalText = btn.innerHTML;
        
        try {
          btn.disabled = true;
          btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
          
          const selectedTools = Array.from(document.querySelectorAll('input[name="tool"]:checked'))
            .map(cb => cb.value);
            
          if (selectedTools.length === 0) {
            alert("Please select at least one tool.");
            return;
          }

          const createFn = functions.httpsCallable("createInvite");
          const result = await createFn({
            tools: selectedTools,
            expiresInDays: 7
          });

          if (result.data.success) {
            const inviteUrlArea = document.getElementById("invite-link-area");
            const inviteUrlInput = document.getElementById("invite-url");
            
            // Construct the tool-specific landing URL
            // For now, we point them to Reviewport which will handle the invite consume flow
            const baseUrl = window.location.origin + window.location.pathname;
            const inviteUrl = `${baseUrl}?invite=${result.data.code}`;
            
            inviteUrlInput.value = inviteUrl;
            inviteUrlArea.classList.add("visible");
          }
        } catch (error) {
          console.error("Invite generation error:", error);
          alert("Failed to generate invite: " + error.message);
        } finally {
          btn.disabled = false;
          btn.innerHTML = originalText;
        }
      }

      function copyInviteUrl() {
        const input = document.getElementById("invite-url");
        input.select();
        document.execCommand("copy");
        
        const btn = event.currentTarget;
        const originalIcon = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check"></i>';
        btn.style.color = "var(--accent-green)";
        
        setTimeout(() => {
          btn.innerHTML = originalIcon;
          btn.style.color = "";
        }, 2000);
      }

      async function runAccessMigration() {
        if (!confirm("This will add 'questions' tool access to all existing users. Proceed?")) return;
        
        const statusEl = document.getElementById("system-status");
        try {
          statusEl.textContent = "Running migration...";
          statusEl.style.color = "var(--accent-blue)";
          
          const migrateFn = functions.httpsCallable("runUnifiedAccessMigration");
          const result = await migrateFn({});
          
          statusEl.textContent = `Migration complete: ${result.data.message}`;
          statusEl.style.color = "var(--accent-green)";
        } catch (error) {
          console.error("Migration error:", error);
          statusEl.textContent = "Migration failed: " + error.message;
          statusEl.style.color = "var(--accent-red)";
        }
      }

      async function seedToolRegistry() {
        const statusEl = document.getElementById("system-status");
        try {
          statusEl.textContent = "Seeding registry...";
          statusEl.style.color = "var(--accent-blue)";
          
          const seedFn = functions.httpsCallable("seedToolRegistry");
          const result = await seedFn({});
          
          statusEl.textContent = `Registry seeded: ${result.data.message}`;
          statusEl.style.color = "var(--accent-green)";
        } catch (error) {
          console.error("Seeding error:", error);
          statusEl.textContent = "Seeding failed: " + error.message;
          statusEl.style.color = "var(--accent-red)";
        }
      }

      async function checkInviteCode() {
        const urlParams = new URLSearchParams(window.location.search);
        const inviteCode = urlParams.get('invite');
        
        if (!inviteCode || !auth.currentUser) return;
        
        try {
          console.log(`[Invite] Attempting to consume code: ${inviteCode}`);
          const consumeFn = functions.httpsCallable("consumeInvite");
          const result = await consumeFn({ code: inviteCode });
          
          if (result.data && result.data.success) {
            const tools = result.data.tools || [];
            const toolsString = tools.length > 0 ? tools.join(', ') : "default tools";
            alert(`Success! You have been granted access to: ${toolsString}\n\nYou can now launch these tools from the hub.`);
            
            // Clear the URL parameter
            window.history.replaceState({}, document.title, window.location.pathname);
            
            // Re-check admin status and refresh stats (might have gained permissions)
            checkAdminAccess();
          }
        } catch (error) {
          console.error("[Invite] Consumption error:", error);
          alert("Failed to accept invite: " + (error.message || "Unknown error"));
          // Clear query param even on failure to prevent loops
          window.history.replaceState({}, document.title, window.location.pathname);
        }
      }
    </script>
  </body>
</html>
